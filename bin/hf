#!/bin/bash

# CLI Utility
#
hf-help() {
    hf-logo
    cat <<EOM >&2

SYNOPSIS

    hf {add,del,show} <OBJECT>
    hf grep <TAG>
    hf tail
EOM
}

hf-logo() {
    printf "\e[32m"
    cat <<EOM >&2
     _      __
    | |    / _|
    | |__ | |_
    | '_ \|  _|
    | | | | |
    |_| |_|_|
EOM
    printf "\e[0m"
}

info() {
    printf "\e[32m[$(date "+%Y-%m-%d %H:%M:%S")] [L${BASH_LINENO}] $@\e[0m\n" >&2
}
warn() {
    printf "\e[33m[$(date "+%Y-%m-%d %H:%M:%S")] [L${BASH_LINENO}] $@\e[0m\n" >&2
}
error() {
    printf "\e[31m[$(date "+%Y-%m-%d %H:%M:%S")] [L${BASH_LINENO}] $@\e[0m\n" >&2
    exit 1
}

# Config
#
if [ -z "$HF_DIR" ]; then
    hf-logo
    error "Error: \$HF_DIR is unset. See Document at https://github.com/cympfh/hf/blob/main/README.md"
fi

if [ ! -d "$HF_DIR" ]; then
    mkdir -p "$HF_DIR"
fi

# Database
#
HF_DB="$HF_DIR/db"

db() {
    if [ $# -eq 0 ]; then
        sqlite3 -separator "	" "$HF_DB"
    else
        sqlite3 -separator "	" "$HF_DB" "$1"
    fi
}

db-init() {
    if [ ! -f "$HF_DB" ]; then
        hf-logo
        db <<EOM
CREATE TABLE objects (
    id INTEGER PRIMARY KEY,
    value TEXT
)
EOM
        db <<EOM
CREATE TABLE images (
    id INTEGER,
    value TEXT
)
EOM
        db <<EOM
CREATE TABLE tags (
    id INTEGER,
    tag TEXT
)
EOM
        info "DB initialized"
    fi
}

db-init

# Twitter Utility
HAS_TWITTER=0
if ( which twurl >/dev/null ) && ( which jq >/dev/null ); then
    HAS_TWITTER=1
fi

twitter-expand-medias() {
    URL="$1"
    TWID=$(echo "$URL" | grep -o '/status/[0-9]*' | grep -o '[0-9]*')
    twurl "/1.1/statuses/show.json?id=$TWID&include_entities=true" |
        jq -r .extended_entities.media[].media_url_https
}

# hf Utility
#
object-type() {
    OBJECT="$1"
    if [ -z "$OBJECT" ]; then
        error "Object required"
    elif ( echo "$OBJECT" | grep '^[0-9]*$' >/dev/null ); then
        echo ID
    elif [ -f "$OBJECT" ] && ( file "$OBJECT" | grep "image data," >/dev/null ); then
        echo FILE
    elif ( echo "$OBJECT" | grep '^https\?://' >/dev/null ) &&
        ( curl -sLI "$OBJECT" | grep content-type | grep "image/" >/dev/null ); then
        echo URL
    elif ( echo "$OBJECT" | grep 'twitter.com/.*/status/[0-9]*' >/dev/null ); then
        echo TWITTER
    else
        error "Unknown Object: $OBJECT"
    fi
}

regularize() {
    OBJECT="$1"
    if [ -z "$OBJECT" ]; then
        error "No Object passed"
    fi
    case "$( object-type "$OBJECT" )" in
        FILE )
            readlink -f "$OBJECT"
            ;;
        URL | TWITTER )
            echo "$OBJECT" | sed 's/^ *https\?:/https:/g'
            ;;
        * )
            echo "$OBJECT"
            ;;
    esac
}

id-of() {
    OBJECT="$1"
    if [ -z "$OBJECT" ]; then
        error "No Object passed"
    fi
    case "$( object-type "$OBJECT" )" in
        FILE )
            db "SELECT id FROM objects WHERE value = '$OBJECT' LIMIT 1"
            ;;
        URL )
            db "SELECT id FROM objects WHERE value = '$OBJECT' LIMIT 1"
            ;;
        TWITTER )
            db "SELECT id FROM objects WHERE value = '$OBJECT' LIMIT 1"
            ;;
        ID )
            db "SELECT id FROM objects WHERE id = '$OBJECT'"
            ;;
        * )
            error "Unsupported Object Type: $OBJECT"
            ;;
    esac
}

# Commands
#
hf-tail() {
    N=10
    FIELDS=value
    while [ $# -gt 0 ]; do
        case "$1" in
            -n )
                N=$2
                shift 2
                ;;
            -I )
                FIELDS="id,value"
                shift
                ;;
            * )
                error "Unknown Option: $1"
                ;;
        esac
    done
    db "SELECT $FIELDS FROM images ORDER BY id DESC LIMIT $N"
}

hf-add() {
    OBJECT=""
    TAGS=""
    while [ $# -gt 0 ]; do
        case "$1" in
            -t | --tag )
                TAGS="$TAGS $2"
                shift 2
                ;;
            * )
                OBJECT="$1"
                shift 1
                ;;
        esac
    done
    if [ -z "$OBJECT" ]; then
        error "No Object passed"
    fi
    OBJECT="$(regularize $OBJECT)"
    EXISTENCE=$(db "SELECT count(*) FROM objects WHERE value = '$OBJECT'")
    if [ "$EXISTENCE" -gt 0 ]; then
        warn "Already exists: $OBJECT"
        exit 0
    fi
    case "$(object-type "$OBJECT")" in
        FILE )
            hf-add-file "$OBJECT" "$TAGS"
            ;;
        URL )
            hf-add-url "$OBJECT" "$TAGS"
            ;;
        TWITTER )
            hf-add-twitter "$OBJECT" "$TAGS"
            ;;
        * )
            error "Unsupported Object Type: $OBJECT"
            ;;
    esac
}

hf-add-file() {
    FILE="$1"
    TAGS="$2"
    info "Add $FILE as File with Tags=$TAGS"
    db "INSERT INTO objects(value) VALUES('$FILE')"
    ID=$(db "SELECT max(id) FROM objects")
    db "INSERT INTO images VALUES($ID, '$FILE')"
    for t in $TAGS; do
        db "INSERT INTO tags VALUES($ID, '$t')"
    done
}

hf-add-url() {
    URL="$1"
    TAGS="$2"
    info "Add $URL as URL with Tags=$TAGS"
    db "INSERT INTO objects(value) VALUES('$URL')"
    ID=$(db "SELECT max(id) FROM objects")
    db "INSERT INTO images VALUES($ID, '$URL')"
    for t in $TAGS; do
        db "INSERT INTO tags VALUES($ID, '$t')"
    done
}

hf-add-twitter() {
    URL="$1"
    TAGS="$2"
    info "Add $URL as URL with Tags=$TAGS"
    db "INSERT INTO objects(value) VALUES('$URL')"
    ID=$(db "SELECT max(id) FROM objects")
    for IM in $(twitter-expand-medias "$URL"); do
        info "Found: $IM"
        db "INSERT INTO images VALUES($ID, '$IM')"
    done
    for t in $TAGS; do
        db "INSERT INTO tags VALUES($ID, '$t')"
    done
}

hf-del() {
    OBJECT="$1"
    if [ -z "$OBJECT" ]; then
        error "No Object passed"
    fi
    ID=$(id-of "$OBJECT")
    if [ -z "$ID" ]; then
        error "No Row for $OBJECT"
    fi
    info "Deleting $ID"
    db "DELETE FROM objects WHERE ID = $ID"
    db "DELETE FROM images WHERE ID = $ID"
    db "DELETE FROM tags WHERE ID = $ID"
}

hf-grep() {
    db "SELECT value FROM images INNER JOIN tags ON images.id = tags.id WHERE tags.tag = '$1'"
}

hf-show() {
    OBJECT="$1"
    if [ -z "$OBJECT" ]; then
        error "No Object passed"
    fi
    OBJECT="$(regularize $OBJECT)"
    ID=$(id-of "$OBJECT")
    if [ -z "$ID" ]; then
        error "No Row for $OBJECT"
    fi
    VAL=$(db "SELECT value FROM objects WHERE id = $ID")
    printf "\e[33mID\e[0m:    $ID\n"
    printf "\e[33mVALUE\e[0m: $VAL\n"
    printf "\e[35mIMAGES:\e[0m\n"
    IMGS=$(db "SELECT value FROM images WHERE id = $ID")
    for im in $IMGS; do
        printf -- "- $im\n"
    done
    printf "\e[35mTAGS:\e[0m\n"
    TAGS=$(db "SELECT tag FROM tags WHERE id = $ID")
    for t in $TAGS; do
        printf -- "- $t\n"
    done

}

hf-tags() {
    if [ $# -eq 0 ]; then
        db "SELECT distinct tag FROM tags group by tag ORDER BY max(id) DESC"
    fi
}

# Entry Point
#
case "$1" in
    a | add )
        shift 1
        hf-add $@
        ;;
    d | del | rm )
        shift 1
        hf-del $@
        ;;
    tail )
        shift 1
        hf-tail $@
        ;;
    g | grep )
        shift 1
        hf-grep $@
        ;;
    s | show )
        shift 1
        hf-show $@
        ;;
    tag | tags )
        shift 1
        hf-tags $@
        ;;
    "" | help | -h | --help )
        hf-help
        ;;
    * )
        error "Unknown command: $1. See help"
        ;;
esac
